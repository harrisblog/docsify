## 一、网际协议 IP

**网际协议 IP** 是 TCP/IP 体系中两个最主要的协议之一。

与 IP 协议配套使用的还有三个协议：

1. **地址解析协议 ARP** (Address Resolution Protocol)

2. **网际控制报文协议 ICMP** (Internet Control Message Protocol)

3. **网际组管理协议 IGMP** (Internet Group Management Protocol)

### 1. 分类 IP 地址

将 IP 地址划分为若干个固定类。每一类地址都由两个固定长度的字段组成：

**网络号 net-id**：它标志主机（或路由器）所连接到的网络

**主机号 host-id**：它标志该主机（或路由器）。

主机号在它前面的网络号所指明的网络范围内必须是唯一的。

由此可见，<u>一个 IP 地址在整个互联网范围内是唯一的</u>。

#### (1) 各类 IP 地址的网络号字段和主机号字段

![](https://npm.elemecdn.com/hassan-assets/posts/Computer_Network/image-20200409174046994.png)

#### (2) 常用的三种类别的 IP 地址

| 网络类别 | 最大可指派的网络数 | 第一个可指派的网络号 | 最后一个可指派的网络号 | 每个网络中最大主机数 |
| :------: | :----------------: | :------------------: | :--------------------: | :------------------: |
|    A     |    126 (27 – 2)    |          1           |          126           |       16777214       |
|    B     |  16383 (214 – 1)   |        128.1         |        191.255         |        65534         |
|    C     | 2097151 (221 – 1)  |       192.0.1        |      223.255.255       |         254          |

#### (3) 一般不使用的特殊 IP 地址

| 网络号 | 主机号                 | 源地址使用 | 目的地址使用 | 代表的意思                                                                  |
| ------ | ---------------------- | ---------- | ------------ | --------------------------------------------------------------------------- |
| 0      | 0                      | 可         | 不可         | 在本网络上的本主机                                                          |
| 0      | host-id                | 可         | 不可         | 在本网络上的某台主机 host-id                                                |
| 全 1   | 全 1                   | 不可       | 可           | 只在本网络上进行广播（各路由器均不转发）                                    |
| net-id | 全 1                   | 不可       | 可           | 对 net-id 上的所有主机进行广播                                              |
| 127    | 非全 0 或全 1 的任何数 | 可         | 可           | 用于本地软件环回测试<br />所以这就是 A 类地址最大可指派的网络数为什么要减 2 |

#### (4) IP 地址的一些重要特点

(1) <u>IP 地址是一种分等级的地址结构</u>。分等级两个的好处是：

1. IP 地址管理机构在分配 IP 地址时只分配**网络号**，而剩下的**主机号**则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。

2. 路由器仅根据目的主机所连接的**网络号**来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。

(2) <u>实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口</u>。

1. 当一个**主机**同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为**多归属主机** (multihomed host)。

2. 由于一个**路由器**至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此<u>一个路由器至少应当有两个不同的 IP 地址</u>。

(3) 用转发器或网桥连接起来的若干个局域网<u>仍为一个网络，因此这些局域网都具有同样的网络号 net-id</u>。

(4) 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。

> 这里看了后能很好的去理解题目为什么这样出

#### (5) 互联网中的 IP 地址

在<u>同一个局域网</u>上的<u>主机</u>或<u>路由器</u>的 IP 地址中的<u>网络号</u>必须是一样的。

网络号就是 IP 地址中的 net-id。

路由器总是具有两个或两个以上的 IP 地址。

路由器的<u>每一个接口都有一个不同网络号的 IP 地址</u>。

两个路由器直接相连的接口处，可指明也可不指明 IP 地址。如指明 IP 地址，则这一段连线就构成了一种只包含一段线路的特殊“网络” 。现在常不指明 IP 地址。

### 2. IP 地址与硬件地址

IP 地址与硬件地址是不同的地址。

从层次的角度看：

1. **硬件地址（或物理地址）**是数据链路层和物理层使用的地址。

2. **IP 地址**是网络层和以上各层使用的地址，是一种逻辑地址（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）。

### 3. 地址解析协议 ARP

通信时使用了两个地址：

1. IP 地址（网络层地址）

2. MAC 地址（数据链路层地址）

#### (1) ARP 的作用

从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。（<u>IP —> MAC</u>）

#### (2) 地址解析协议 ARP 要点

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用**硬件地址**。

- 每一个主机都设有一个 **ARP 高速缓存** (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

- 当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。

  - <u>如有</u>，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。

  - <u>如没有</u>， ARP 进程在本局域网上<u>广播发送一个 ARP 请求分组</u>。收到 <u>ARP 响应分组</u>后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

- **ARP 请求分组**：包含发送方 MAC 地址 / 发送方 IP 地址 / 目标方 MAC 地址(未知时填 0) / 目标方 IP 地址。

- <u>本地广播 ARP 请求</u>（路由器不转发 ARP 请求）。

- **ARP 响应分组**：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址 / 目标方 IP 地址。

- <u>ARP 分组封装在物理网络的帧中传输</u>。

#### (3) ARP 高速缓存的作用

- <u>存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量</u>。

- 为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。

- 当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。

#### (4) 应当注意的问题

- ARP 用于解决<u>同一个局域网</u>上的主机或路由器的 IP 地址和硬件地址的映射问题。

- 如果所要找的主机和源主机不在同一个局域网上，那么<u>就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址</u>，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。

- 从 IP 地址到硬件地址的<u>解析是自动进行</u>的，主机的用户对这种地址解析过程是不知道的。

- 只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。

#### (5) 使用 ARP 的四种典型情况

1. 发送方是主机，要把 IP 数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址。

2. 发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。

3. 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。

4. 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。

### 4. IP 数据报格式

- 一个 IP 数据报由**首部**和**数据**两部分组成。

- <u>首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的</u>。

- 在首部的固定部分的后面是一些可选字段，其长度是可变的。

#### (1) IP 数据报首部固定部分中的各字段

![](https://npm.elemecdn.com/hassan-assets/posts/Computer_Network/image-20200413201234112.png)

**版本**：占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)。

**首部长度**：占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。

**区分服务**：占 8 位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过。1998 年这个字段改名为区分服务。只有在使用区分服务（DiffServ）时，这个字段才起作用。在一般的情况下都不使用这个字段

**总长度**：占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元 MTU。

**标识 **(identification) ：占 16 位，它是一个计数器，用来产生 IP 数据报的标识。

**标志** (flag) ：——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF=1 表示后面“还有分片”。MF=0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF=0 时才允许分片。

**片偏移**：占 13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。

**生存时间**：占 8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。

**协议**：占 8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程

**首部检验和**：占 16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。

**源地址**和**目的地址**都各占 4 字节

#### (2) IP 数据报首部的可变部分

- IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。

- 选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。

- 增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。

- 实际上这些选项很少被使用。

### 5. IP 层转发分组的流程

- 按主机所在的**网络地址**来制作**路由表**

- 在路由表中，对每一条路由，最主要的是：**目的网络地址** + **下一跳地址**

#### (1) 查找路由器

根据**目的网络地址**就能确定**下一跳路由器**，这样做的结果是：

- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的**间接交付**）。

- 只有到达最后一个路由器时，才试图向目的主机进行**直接交付**。

#### (2) 特定主机路由

- 虽然互联网所有的分组转发都是<u>基于目的主机所在的网络</u>，但在大多数情况下都允许有这样的特例，即<u>为特定的目的主机指明一个路由</u>。

- 采用**特定主机路由**可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

#### (3) **默认路由**

- 路由器还可采用**默认路由**==<u>以减少路由表所占用的空间和搜索路由表所用的时间</u>==。

- 这种转发方式在一个网络只有很少的对外连接时是很有用的。

- 默认路由在主机发送 IP 数据报时往往更能显示出它的好处。

- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。

#### (4) 关于路由表

- 路由表没有给分组指明到某个网络的完整路径。

- <u>路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）</u>。

- 在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。

- 这样一步一步地查找下去，直到最后到达目的网络。

## 二、划分子网和构造超网

### 1. 划分子网

#### (1) 从两级 IP 地址到三级 IP 地址

##### 划分子网基本思路

- 划分子网纯属一个<u>单位内部的事情</u>。单位对外仍然表现为没有划分子网的网络（透明性）。

- 从主机号<u>借用</u>若干个位作为**子网号** subnet-id，而主机号 host-id 也就相应<u>减少</u>了若干个位。

- 凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的**目的网络号** net-id，先找到连接在<u>本单位网络上的路由器</u>。

- 然后<u>此路由器</u>在收到 IP 数据报后，再按**目的网络号** net-id 和**子网号** subnet-id 找到目的子网。

- 最后就将 IP 数据报直接交付目的主机。

> 注：划分子网只是把 IP 地址的主机号这部分进行再划分，而<u>不改变 IP 地址原来的网络号</u>。

#### (2) 子网掩码

从一个 IP 数据报的首部并<u>无法判断</u>源主机或目的主机所连接的网络<u>是否进行了子网划分</u>。使用**子网掩码** (subnet mask) 可以找出 IP 地址中的子网部分。

##### A. 规则

- 子网掩码长度 ＝ 32 位

- 子网掩码左边部分的一连串 1，对应于**网络号**和**子网号**

- 子网掩码右边部分的一连串 0，对应于**主机号**

##### B. 默认子网掩码

**A 类地址**：255.0.0.0

**B 类地址**：255.255.0.0

**C 类地址**：255.255.255.0

> 注：只针对二级 IP 地址

##### C. 子网掩码是一个重要属性

- 子网掩码是一个网络或一个子网的重要属性。

- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。

- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。

- 若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。

### 2. 使用子网时分组的转发

- 在不划分子网的两级 IP 地址下，从 IP 地址得出网络地址是个很简单的事。

- 但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但数据报的首部并没有提供子网掩码的信息。

- 因此分组转发的算法也必须做相应的改动。

#### 在划分子网情况下路由器转发分组的算法

1. 从收到的分组的首部提取<u>目的 IP 地址 D</u>。

2. 先用各网络的<u>子网掩码和 _D_ 逐位相“与”</u>，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。

3. 若路由表中有目的地址为 _D_ 的<u>特定主机路由</u>，则将分组传送给指明的下一跳路由器；否则，执行 (4)。

4. 对路由表中的每一行，将<u>子网掩码和 _D_ 逐位相“与”</u>。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)。

5. 若路由表中有一个<u>默认路由</u>，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)。

6. 报告转发分组出错。

### 3. 无分类编址 CIDR（构造超网）

#### (1) 网络前缀

##### A. CIDR 最主要的特点

- CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。

- CIDR 使用各种长度的“**网络前缀**”(network-prefix)来代替分类地址中的网络号和子网号。

- <u>IP 地址从三级编址（使用子网掩码）又回到了两级编址</u>。

##### B. 无分类的两级编址

- 无分类的两级编址的记法是： {<网络前缀>, <主机号>}

- CIDR 使用“斜线记法”(slash notation)，它又称为 CIDR 记法，即在 IP 地址面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24

##### C. CIDR 地址块

- CIDR 把网络前缀都相同的连续的 IP 地址组成“**CIDR 地址块**”。

- 128.14.32.0/20 表示的地址块<u>共有 212 个地址</u>（因为<u>斜线后面的 20 是网络前缀的位数</u>，所以这个地址的主机号是 12 位）。

1. 这个地址块的起始地址是 128.14.32.0。

2. 在不需要指出地址块的起始地址时，也可将这样的地址块简称为“<u>/20 地址块</u>”。

3. 128.14.32.0/20 地址块的最小地址：128.14.32.0

4. 128.14.32.0/20 地址块的最大地址：128.14.47.255

5. <u>全 0 和全 1 的主机号地址一般不使用</u>。

##### D. CIDR 记法的其他形式

- 10.0.0.0/10 可<u>简写</u>为 10/10，也就是把点分十进制中低位连续的 0 省略。

- 10.0.0.0/10 隐含地指出 IP 地址 10.0.0.0 的<u>掩码</u>是 255.192.0.0。此掩码可表示为：

- 网络前缀的后面加一个<u>星号</u> _ 的表示方法，如 00001010 00_，在星号 _ 之前是网络前缀，而星号 _ 表示 IP 地址中的主机号，可以是任意值。

#### (2) 最长前缀匹配

- 使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。<u>在查找路由表时可能会得到不止一个匹配结果</u>。

- 应当从匹配结果中选择具有最长网络前缀的路由：**最长前缀匹配** (longest-prefix matching)。

- 网络前缀越长，其地址块就越小，因而路由就越<u>具体</u>。

- 最长前缀匹配又称为**最长匹配**或**最佳匹配**。

#### (3) 使用二叉线索查找路由表

- 当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题。

- <u>为了进行更加有效的查找</u>，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后<u>自上而下地按层次</u>进行查找。这里最常用的就是**二叉线索** (binary trie)。

- IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址。

- 为了提高二叉线索的查找速度，广泛使用了各种压缩技术。

## 三、网际控制报文协议 ICMP

### 1. ICMP 报文的种类

- ICMP 报文的种类有两种，即 ICMP **差错报告报文**和 ICMP **询问报文**。

- ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即**类型**、**代码**和**检验和**。接着的 4 个字节的内容与 ICMP 的类型有关。

#### (1) 不应发送 ICMP 差错报告报文的几种情况

- 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。

- 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。

- 对具有多播地址的数据报都不发送 ICMP 差错报告报文。

- 对具有特殊地址（如 127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

#### (2) ICMP 询问报文有两种

- 回送请求和回答报文

- 时间戳请求和回答报文

<u>下面的几种 ICMP 报文不再使用：</u>

- 信息请求与回答报文

- 掩码地址请求和回答报文

- 路由器询问和通告报文

- 源点抑制报文

### 2. ICMP 的应用举例

**PING** (Packet InterNet Groper)

- <u>PING 用来测试两个主机之间的连通性</u>。

- PING 使用了 ICMP 回送请求与回送回答报文。

- PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或 UDP。

**Traceroute** 的应用举例：

- 在 Windows 操作系统中这个命令是 tracert。

- <u>用来跟踪一个分组从源点到终点的路径</u>。

- 它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告报文实现对从源点到终点的路径的跟踪。

## 四、互联网的路由选择协议

### 1. 有关路由选择协议的几个基本概念

#### (1) 理想的路由算法

- 算法必须是正确的和完整的。

- 算法在计算上应简单。

- 算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。

- 算法应具有稳定性。

- 算法应是公平的。

- 算法应是最佳的。

##### A. 关于“最佳路由”

- 不存在一种绝对的最佳路由算法。

- <u>所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已</u>。

- 实际的路由选择算法，应尽可能接近于理想的算法。

- 路由选择是个非常复杂的问题

1. <u>它是网络中的所有结点共同协调工作的结果</u>。

2. <u>路由选择的环境往往是不断变化的，而这种变化有时无法事先知道</u>。

##### B. 从路由算法的自适应性考虑

- **静态**路由选择策略——即**非自适应路由选择**，其特点是简单和开销较小，但不能及时适应网络状态的变化。

- **动态**路由选择策略——即**自适应路由选择**，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。

#### (2) 分层次的路由选择协议

互联网采用分层次的路由选择协议，是因为：

(1) 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。

(2) 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。

##### A. 自治系统 AS (Autonomous System)

- <u>自治系统 AS 的定义</u>：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS 之间的路由。

- 现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但<u>重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略</u>。

##### B. 互联网有两大类路由选择协议

- **内部网关协议** IGP (Interior Gateway Protocol)

1. 在一个自治系统<u>内部使用</u>的路由选择协议。

2. 目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

- **外部网关协议** EGP (External Gateway Protocol)

1. 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议<u>将路由选择信息传递到另一个自治系统中</u>。这样的协议就是外部网关协议 EGP。

2. 在外部网关协议中目前使用最多的是 BGP-4。

##### C. 自治系统和内部网关协议、外部网关协议

自治系统之间的路由选择也叫做**域间路由选择** (interdomain routing).

在自治系统内部的路由选择叫做**域内路由选择** (intradomain routing) 。

### 2. 内部网关协议 RIP

#### (1) 工作原理

- 路由信息协议 RIP (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议。

- RIP 是一种<u>分布式的、基于距离向量的路由选择协议</u>。

- <u>RIP 协议</u>要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

##### A. “距离”的定义

- 从一个路由器到<u>直接连接</u>的网络的距离定义为 1。

- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。

- RIP 协议中的“距离”也称为“**跳数**”(hop count)，因为每经过一个路由器，跳数就加 1。

- 这里的“距离”实际上指的是“**最短距离**”。

- RIP 认为一个<u>好的路由</u>就是它通过的路由器的数目少，即“距离短”。

- RIP 允许一条路径<u>最多</u>只能包含 <u>15</u> 个路由器。

- “距离”的最大值为 <u>16</u> 时即相当于<u>不可达</u>。可见 RIP 只适用于小型互联网。

- <u>RIP 不能在两个网络之间同时使用多条路由</u>。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。

##### B. RIP 协议的三个特点

1. 仅和相邻路由器交换信息。

2. 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。

3. 按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

##### C. 路由表的建立

- 路由器在<u>刚刚开始工作</u>时，只知道到直接连接的网络的距离（此距离定义为 1）。它的<u>路由表是空的</u>。
- 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
- RIP 协议的**收敛** (convergence) 过程较快。“收敛” 就是在自治系统中所有的结点都得到正确的路由选择信息的过程。

#### (2) ⭐ 距离向量算法

路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：

(1) 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，<u>并把所有的“距离”字段的值加 1</u>。

(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：

```mysql
IF 项目中的目的网络不在自己的路由表中，则把该项目加到自己的路由表中。
ELSEIF 下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。
ELSEIF 收到项目中的距离小于路由表中的距离，则进行更新，
ELSEIF 否则，什么也不做。
```

(3) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。

(4) 返回。

##### 路由器之间交换信息与路由表更新

- RIP 协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。
- 虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的。

#### (3) RIP2 协议的报文格式

- RIP2 报文由首部和路由部分组成。

- RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 20 个字节。**地址族标识符**（又称为**地址类别**）字段用来标志所使用的地址协议。

- 路由标记填入自治系统的号码，这是考虑使 RIP 有可能收到本自治系统以外的路由选择信息。

- 再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。
- 一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 4+20 x25=504 字节。如超过，必须再用一个 RIP 报文来传送。

- <u>RIP2 具有简单的鉴别功能</u>。

1. 若使用鉴别功能，则将原来写入第一个路由信息（20 个字节）的位置用作鉴别。

2. 在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。

##### RIP 协议的优缺点

- **优点**：实现简单，开销较小。

- **缺点**：

1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。

2. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。

3. “坏消息传播得慢”，使更新过程的收敛时间过长。

### 3. 内部网关协议 OSPF

背景：开放最短路径优先 OSPF 是为<u>克服</u> RIP 的缺点。<u>OSPF 的原理很简单，但实现起来却较复杂</u>。

#### (1) OSPF 协议的基本特点

1. **开放**：不受一个厂商控制，而是公开发表的。
2. **最短路径优先**：使用了最短路径算法 SPF。
3. 采用**分布式的链路状态协议**。

> 注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

##### A. 三个要点

- 向本自治系统中所有路由器发送信息，这里使用的方法是**洪泛法**。

- 发送的信息就是与本路由器<u>相邻</u>的所有路由器的**链路状态**，但这只是路由器所知道的**部分信息**。

  - “**链路状态**”就是说明本路由器都和哪些路由器相邻，以及该链路的“**度量**”。

- 只有当链路状态<u>发生变化</u>时，路由器才用洪泛法向所有路由器发送此信息。

##### B. 链路状态数据库

- 由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。

- 这个数据库实际上就是<u>全网的拓扑结构图，它在全网范围内是一致的</u>（这称为链路状态数据库的同步）。

- OSPF 的链路状态数据库能<u>较快地进行更新</u>，使各个路由器能及时更新其路由表。

- <u>OSPF 的更新过程收敛得快是其重要优点</u>。

##### C. OSPF 的区域

- 为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做**区域**。

- 每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。

- 区域也不能太大，在一个区域内的路由器最好不超过 200 个。

##### D. 划分区域

- 划分区域的<u>好处</u>就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。

- <u>在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况</u>。

- OSPF 使用<u>层次结构的区域划分</u>。在上层的区域叫做**主干区域**。

- 主干区域的标识符规定为 0.0.0.0。主干区域的<u>作用</u>是用来连通其他在下层的区域。

##### E. OSPF 直接用 IP 数据报传送

- <u>OSPF 不用 UDP 而是直接用 IP 数据报传送</u>。

- OSPF 构成的数据报很短。这样做可减少路由信息的通信量。

- 数据报很短的另一好处是可以不必将长的数据报分片传送。

- 但分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。

##### F. OSPF 的其他特点

- OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，<u>OSPF 对于不同类型的业务可计算出不同的路由</u>。

- 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做<u>多路径间的负载平衡</u>。

- 所有在 OSPF 路由器之间交换的分组都具有<u>鉴别</u>的功能。

- <u>支持可变长度的子网划分和无分类编址 CIDR</u>。

- 每一个链路状态都带上一个 32 位的序号，序号越大状态就越新。

#### (2) OSPF 的五种分组类型

1. 问候分组。

2. 数据库描述分组。

3. 链路状态请求分组。

4. 链路状态更新分组，用洪泛法对全网更新链路状态。

5. 链路状态确认分组。

##### A. OSPF 的其他特点

- OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。

- 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此<u>当互联网规模很大时</u>，<u>OSPF 协议要比距离向量协议 RIP 好得多</u>。

- <u>OSPF 没有“坏消息传播得慢”的问题</u>，据统计，其响应网络变化的时间小于 100 ms。

##### B. 指定的路由器

- 多点接入的局域网采用了**指定的路由器**的方法，使广播的信息量大大减少。

- 指定的路由器<u>代表</u>该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。

### 4. 外部网关协议 BGP

BGP 是<u>不同自治系统的路由器之间</u>交换路由信息的协议。

#### (1) BGP 使用环境不同

- 互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。

1. 当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。

2. <u>比较合理的做法是在 AS 之间交换“可达性”信息</u>。

- 自治系统之间的路由选择必须考虑有关<u>策略</u>。

- 因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且<u>比较好的路由</u>（不能兜圈子），而<u>并非要寻找一条最佳路由</u>。

#### (2) BGP 发言人

- 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ **BGP 发言人**”。

- 一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。

#### (3) BGP 交换路由信息

- 一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 <u>TCP 连接</u>，然后在此连接上交换 BGP 报文以建立 BGP **会话**(session)，利用 BGP 会话交换路由信息。

- 使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。

- 使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的**邻站**或**对等站** 。

#### (4) BGP 协议的特点

- BGP 协议交换路由信息的结点数量级是<u>自治系统数的量级</u>，这要比这些自治系统中的网络数少很多。

- 每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。

- <u>BGP 支持 CIDR</u>，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。

- 在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时<u>更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处</u>。

#### (5) BGP-4 共使用四种报文

1. 打开报文：用来与相邻的另一个 BGP 发言人建立关系。

2. 更新报文：用来发送某一路由的信息，以及列出要撤消的多条路由。

3. 保活报文：用来确认打开报文和周期性地证实邻站关系。

4. 通知报文：用来发送检测到的差错。

### 5. 路由器的构成

### 6. IPv6

背景：IPv4 的 32 位地址已经耗尽，解决措施是采用具有更大地址空间的新版本 IP，即 IPv4

#### (1) IPv6 的基本首部

- IPv6 仍支持<u>无连接的传送</u>，但将协议数据单元 PDU 称为**分组**。为方便起见，本书仍采用数据报这一名词。

- 所引进的<u>主要变化</u>如下：

1. **更大的地址空间**。IPv6 将地址从 IPv4 的 32 位 增大到了 128 位。

2. **扩展的地址层次结构**。

3. **灵活的首部格式**。 IPv6 定义了许多可选的扩展首部。

4. **改进的选项**。 IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。
5. **允许协议继续扩充**。
6. **支持即插即用（即自动配置）**。因此 IPv6 不需要使用 DHCP。
7. **支持资源的预分配**。 IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。
8. **IPv6 首部改为 8 字节对齐**。首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐。

##### A. IPv6 数据报的一般形式

- IPv6 数据报由两大部分组成：

1. 基本首部

2. 有效载荷。有效载荷也称为净负荷。有效载荷允许有零个或多个扩展首部，再后面是数据部分。

![](https://npm.elemecdn.com/hassan-assets/posts/Computer_Network/image-20200521165209378.png)

##### B. IPv6 数据报的基本首部

- IPv6 将首部长度变为<u>固定的 40 字节</u>，称为**基本首部**。

- 把首部中不必要的功能取消了，使得 IPv6 首部的字段数减少到只有 8 个。

- IPv6 对首部中的某些字段进行了如下的<u>更改</u>：

  - 取消了首部长度字段，因为首部长度是固定的 40 字节；
  - 取消了服务类型字段；
  - 取消了总长度字段，改用有效载荷长度字段；
  - 把 TTL 字段改称为跳数限制字段；
  - 取消了协议字段，改用下一个首部字段；

  - 取消了检验和字段；
  - 取消了选项字段，而用扩展首部来实现选项功能。

![](https://npm.elemecdn.com/hassan-assets/posts/Computer_Network/image-20200521171358430.png)

**版本**—— 4 位。它指明了协议的版本，对 IPv6 该字段总是 6。

**通信量类**—— 8 位。这是为了区分不同的 IPv6 数据报的类别或优先级。目前正在进行不同的通信量类性能的实验。

**流标号**—— 20 位。 “流”是互联网络上从特定源点到特定终点的一系列数据报， “流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号。

**有效载荷长度**—— 16 位。它指明 IPv6 数据报除基本首部以外的字节数（所有扩展首部都算在有效载荷之内），其最大值是 64 KB。

**下一个首部**—— 8 位。它相当于 IPv4 的协议字段或可选字段。

**跳数限制**—— 8 位。源站在数据报发出时即设定跳数限制。路由器在转发数据报时将跳数限制字段中的值减 1。当跳数限制的值为零时，就要将此数据报丢弃。

**源地址**—— 128 位。是数据报的发送站的 IP 地址。

**目的地址**—— 128 位。是数据报的接收站的 IP 地址。

##### C. IPv6 的扩展首部

- IPv6 把原来 IPv4 首部中选项的功能都放在<u>扩展首部</u>中，并将扩展首部留给路径两端的源站和目的站的主机来处理。

- <u>数据报途中经过的路由器都不处理这些扩展首部（只有一个首部例外，即逐跳选项扩展首部）</u>。

- 这样就<u>大大提高了路由器的处理效率</u>。

##### D. 六种扩展首部

在 RFC 2460 中定义了六种扩展首部：

1. 逐跳选项

2. 路由选择

3. 分片

4. 鉴别

5. 封装安全有效载荷

6. 目的站选项

#### (2) IPv6 的地址

- IPv6 数据报的目的地址可以是以下三种基本类型地址之一：

1. **单播**：传统的点对点通信。

2. **多播**：一点对多点的通信。

3. **任播**：这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个。

##### A. 结点与接口

- IPv6 将实现 IPv6 的主机和路由器均称为**结点**。

- 一个结点就可能有多个与链路相连的接口。

- IPv6 地址是分配给结点上面的接口的。

1. <u>一个接口可以有多个单播地址</u>。

2. <u>其中的任何一个地址都可以当作到达该结点的目的地址。即一个结点接口的单播地址可用来唯一地标志该结点</u>。

##### B. 冒号十六进制记法

- 在 IPv6 中，每个地址占 128 位，地址空间大于 3.4 x 10^38^ 。

- 为了使地址再稍简洁些，IPv6 使用**冒号十六进制记法** (简写为 colon hex)。

- 每个 16 位的值用十六进制值表示，各值之间用冒号分隔。例如：

  <u>68E6 : 8C64 : FFFF : FFFF : 0 : 1180 : 960A : FFFF</u>

- 在十六进制记法中，允许把数字前面的 0 省略。例如把 0000 中的前三个 0 省略，写成 1 个 0。

##### C. 零压缩

- 冒号十六进制记法可以允许**零压缩**，即一连串连续的零可以为一对冒号所取代。

  FF05 : 0 : 0 : 0 : 0 : 0 : 0 : B3 可压缩为：

  FF05 :: B3

- <u>注意：在任一地址中只能使用一次零压缩</u>。

##### D. 点分十进制记法的后缀

- 冒号十六进制记法可结合使用点分十进制记法的后缀，这种结合在 IPv4 向 IPv6 的转换阶段特别有用。

- 例如：<u>0 : 0 : 0 : 0 : 0 : 0 : 128.10.2.1</u>

  再使用零压缩即可得出： <u>:: 128.10.2.1</u>

- <u>CIDR 的斜线表示法仍然可用</u>。

- 例如：60 位的前缀 12AB00000000CD3 可记为：

  <u>12AB : 0000 : 0000 : CD30 : 0000 : 0000 : 0000 : 0000/60</u>

或 <u>12AB :: CD30 : 0 : 0 : 0 : 0/60 （零压缩）</u>

或 <u>12AB : 0 : 0 : CD30 :: /60 （零压缩）</u>

##### E. IPv6 地址分类

| 地址类型         | 二进制前缀                             |
| ---------------- | -------------------------------------- |
| 未指明地址       | 00…0（128 位），可记为 ::/128          |
| 环回地址         | 00…1（128 位），可记为 ::1/128         |
| 多播地址         | 11111111（8 位），可记为 FF00::/8      |
| 本地链路单播地址 | 1111111010（10 位）, 可记为 FE80::/10  |
| 全球单播地址     | （除上述四种外，所有其他的二进制前缀） |

- **未指明地址**

1. 这是 16 字节的全 0 地址，可缩写为两个冒号 “ :: ”。

2. 这个地址只能为还没有配置到一个标准的 IP 地址的主机当作源地址使用。

3. 这类地址仅此一个。

- **环回地址**

1. 即 0 : 0 : 0 : 0 : 0 : 0 : 0 : 1（记为 :: 1）。

2. 作用和 IPv4 的环回地址一样。

3. 这类地址也是仅此一个。

- **多播地址**

1. 功能和 IPv4 的一样。

2. 这类地址占 IPv6 地址总数的 1/256。

- **本地链路单播地址**

1. 有些单位的网络使用 TCP/IP 协议，但<u>并没有连接到互联网上</u>。连接在这样的网络上的主机都可以使用这种本地地址进行通信，但不能和互联网上的其他主机通信。

2. 这类地址占 IPv6 地址总数的 1/1024。

- **全球单播地址**

1. IPv6 的这一类单播地址是使用得最多的一类。

2. 曾提出过多种方案来进一步划分这 128 位的单播地址。

3. 根据 2006 年发布的草案标准 RFC 4291 的建议， IPv6 单播地址的划分方法非常灵活。

#### (3) 从 IPv4 向 IPv6 过渡

- 向 IPv6 过渡<u>只能采用逐步演进的办法</u>，同时，还必须使新安装的 IPv6 系统能够<u>向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由</u>。

- 两种向 IPv6 过渡的策略：

1. <u>使用双协议栈</u>

2. <u>使用隧道技术</u>

##### A. 双协议栈

- **双协议栈** 是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）<u>装有两个协议栈，一个 IPv4 和一个 IPv6</u>。

- 双协议栈的主机（或路由器）记为 IPv6/IPv4，表明它<u>同时具有两种 IP 地址：一个 IPv6 地址和一个 IPv4 地址</u>。

- 双协议栈主机在和 IPv6 主机通信时是采用 IPv6 地址，而和 IPv4 主机通信时就采用 IPv4 地址。

- 根据 DNS 返回的地址类型可以确定使用 IPv4 地址还是 IPv6 地址。

##### B. 隧道技术

- 在 IPv6 数据报要进入 IPv4 网络时，<u>把 IPv6 数据报封装成为 IPv4 数据报</u>，整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。

- 当 IPv4 数据报离开 IPv4 网络中的隧道时，再把数据部分（即原来的 IPv6 数据报）交给主机的 IPv6 协议栈。

#### (4) ICMPv6

- IPv6 也不保证数据报的可靠交付，因为互联网中的路由器可能会丢弃数据报。

- 因此 IPv6 也需要使用 ICMP 来反馈一些差错信息。新的版本称为 ICMPv6。

- 地址解析协议 ARP 和网际组管理协议 IGMP 协议的功能都已被合并到 ICMPv6 中。

##### ICMPv6 报文的分类

- CMPv6 是面向报文的协议，它利用报文来报告差错，获取信息，探测邻站或管理多播通信。

- ICMPv6 还增加了几个定义报文的功能及含义的其他协议。

### 7. IP 多播

#### (1) IP 多播的基本概念

- **IP 多播** (曾译为组播) 已成为互联网的一个热门课题。

- **目的**：更好地支持<u>一对多通信</u>。

- **一对多通信**：一个源点发送到许多个终点。
  - 例如，实时信息的交付（如新闻、股市行情等），软件更新，交互式会议及其他多媒体通信。
- **优点**：多播可大大节约网络资源

##### A. 多播 IP 地址

- IP 多播所传送的分组需要使用<u>多播 IP 地址</u>。

- 在多播数据报的目的地址写入的是<u>多播组</u>的标识符。

- <u>多播组的标识符就是 IP 地址中的 D 类地址（多播地址）</u>。

- 每一个 D 类地址标志一个多播组。

- 多播地址<u>只能</u>用于目的地址，<u>不能</u>用于源地址。

##### B. 多播数据报

- 多播数据报和一般的 IP 数据报的区别就是它<u>使用 D 类 IP 地址</u>作为目的地址，并且首部中的协议字段值是 2，表明<u>使用网际组管理协议</u> IGMP。

- 多播数据报也是“<u>尽最大努力交付</u>”，不保证一定能够交付多播组内的所有成员。

- 对多播数据报<u>不产生 ICMP 差错报文</u>。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应。

#### (2) 在局域网上进行硬件多播

- 互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E。

- 因此 TCP/IP 协议使用的以太网地址块的范围是

  从 <u>00 - 00 - 5E - 00 - 00 - 00</u>

  到 <u>00 - 00 - 5E - FF - FF - FF</u>

- 不难看出，在每一个地址中，只有 23 位可用作多播。

- D 类 IP 地址可供分配的有 28 位，在这 28 位中的前 5 位不能用来构成以太网硬件地址。

##### D 类 IP 地址与以太网多播地址的映射关系

由于多播 IP 地址与以太网硬件地址的映射关系<u>不是唯一</u>的，因此收到多播数据报的主机，<u>还要在 IP 层利用软件进行过滤</u>，把不是本主机要接收的数据报丢弃。

#### (3) 网际组管理协议 IGMP 和多播路由选择协议

##### IP 多播需要两种协议

- 为了使路由器知道多播组成员的信息，需要利用<u>网际组管理协议</u> IGMP。

- 连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用<u>多播路由选择协议</u>。

###### IGMP 的使用范围

- IGMP <u>并非</u>在互联网范围内对所有多播组成员进行管理的协议。

- IGMP <u>不知道</u> IP 多播组包含的成员数，<u>也不知道</u>这些成员都分布在哪些网络上。

- <u>IGMP 协议是让连接在**本地局域网上**的多播路由器知道本局域网上是否有主机（严格讲，是主机上的某个进程）参加或退出了某个多播组</u>。
